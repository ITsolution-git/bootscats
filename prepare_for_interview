#!/usr/bin/env bash

set -e

# Remove all nested git repositories while preserving the root repository
# Git ignores any nested repos and treats the entire folder as if it's git ignored.
# If a candidate creates a nested repo in one of the folders it will be ignored
# Git doesn't provide a way of disabling this, so we'll delete the .git folders manually
# This was written by Claude
echo "Searching for nested git repositories..."

# Count how many we find
count=0

# Find and remove nested .git directories (mindepth 2 skips the root .git)
while IFS= read -r -d '' git_dir; do
    echo "  Removing: $git_dir"
    rm -rf "$git_dir"
    count=$((count + 1))
done < <(find . -mindepth 2 -name ".git" -type d -print0 2>/dev/null)

# Find and remove nested .git files (used by submodules/worktrees)
while IFS= read -r -d '' git_file; do
    echo "  Removing: $git_file"
    rm -f "$git_file"
    count=$((count + 1))
done < <(find . -mindepth 2 -name ".git" -type f -print0 2>/dev/null)

if [ $count -eq 0 ]; then
    echo "No nested git repositories found."
else
    echo "Removed $count nested git repositor(y|ies)."
fi

# After removing .git directories, reset git's cache for those directories
find . -mindepth 2 -type d | while read dir; do
    # Check if directory has files but git thinks it's empty/ignored
    if [ "$(ls -A "$dir" 2>/dev/null)" ] && ! git ls-files --error-unmatch "$dir" >/dev/null 2>&1; then
        git rm -rf --cached "$dir" 2>/dev/null || true
        git add "$dir" 2>/dev/null || true
    fi
done

current_branch="$(git rev-parse --abbrev-ref HEAD)"

if [ "$current_branch" != "master" ]; then
    git add -A
    git commit -am "Interview complete" || true
    git checkout master
    git reset HEAD --hard
fi

read -p "Candidate first name:" branch_name
git checkout -b "interview--$(date +%s)-$branch_name"

read -p "Enter a new password for the code server:" server_password

sudo docker rm --force interviewing-code-server || true

# Clear Claude Code chat history before starting new interview
# This ensures each interview starts with a clean chat history while preserving authentication
sudo rm -rf /home/ubuntu/.claude/projects || true
sudo rm -f /home/ubuntu/.claude/history.jsonl || true

# Ensure directories exist and have correct permissions
# Mount only necessary directories to preserve authentication and configuration while excluding bash history
sudo mkdir -p /home/ubuntu/.config
sudo mkdir -p /home/ubuntu/.local/share/code-server/User/globalStorage
sudo mkdir -p /home/ubuntu/.claude
sudo mkdir -p /home/ubuntu/.codex
sudo mkdir -p /home/ubuntu/.npm
sudo mkdir -p /home/ubuntu/.cache
# Ensure directories are owned by UID 1000 (coder user in container) and are writable
sudo chown -R 1000:1000 /home/ubuntu/.config || true
sudo chown -R 1000:1000 /home/ubuntu/.local || true
sudo chown -R 1000:1000 /home/ubuntu/.claude || true
sudo chown -R 1000:1000 /home/ubuntu/.codex || true
sudo chown -R 1000:1000 /home/ubuntu/.npm || true
sudo chown -R 1000:1000 /home/ubuntu/.cache || true
# Ensure .claude.json files exist (create empty if they don't to allow mounting)
sudo touch /home/ubuntu/.claude.json /home/ubuntu/.claude.json.backup || true
sudo chown 1000:1000 /home/ubuntu/.claude.json /home/ubuntu/.claude.json.backup || true

# Use host network mode so container can bind to 7535 directly
# Note: This means the container shares the host's network namespace
# Mount only necessary directories/files:
# - .config: CLI credentials (~/.config/claude/credentials), code-server config, and extension auth (~/.config/claude-code/auth.json)
# - .local: code-server extensions and globalStorage (extension logins at ~/.local/share/code-server/User/globalStorage)
# - .claude: Claude extension directory data (chat history cleared above, will be recreated in container)
# - .claude.json/.claude.json.backup: Claude configuration files in home root
# - .codex: Codex extension data
# - .npm: Global npm packages
# - .cache: Extension cache data (some extensions store auth tokens here)
# - project: Project files
# Override bash history to prevent persistence:
# - .bash_history -> /dev/null (prevents bash history from persisting)
# Chat history is cleared above before container starts, so it won't persist between interviews
sudo docker create --restart unless-stopped --network host -e "PASSWORD=$server_password" --name "interviewing-code-server" -v /home/ubuntu/.config:/home/coder/.config -v /home/ubuntu/.local:/home/coder/.local -v /home/ubuntu/.claude:/home/coder/.claude -v /home/ubuntu/.claude.json:/home/coder/.claude.json -v /home/ubuntu/.claude.json.backup:/home/coder/.claude.json.backup -v /home/ubuntu/.codex:/home/coder/.codex -v /home/ubuntu/.npm:/home/coder/.npm -v /home/ubuntu/.cache:/home/coder/.cache -v /home/ubuntu/project:/home/coder/project -v /dev/null:/home/coder/.bash_history --cap-add=SYS_PTRACE code-server:academia --verbose

sudo docker start interviewing-code-server

