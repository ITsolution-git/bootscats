(function(){var BC,Server,net;net=require("net");Server=function(){function Server(port){if(port==null){port=7535}this.port=parseInt(port,10);this.s=net.createServer();this.circle=[];this.players={};this.current_player=null;this.current_number=null;this.timeout=null}Server.prototype.start=function(){var _this=this;this.s.on("connection",function(c){return _this.configure_player(c)});return this.s.listen(this.port,function(){return console.log("started")})};Server.prototype.stop=function(){};Server.prototype.configure_player=function(c){var id,_this=this;id=""+c.remoteAddress+":"+c.remotePort;this.add_to_circle(id,c);c.on("data",function(buffer){return _this.handle_data(id,buffer.toString().replace(/(\n|\r)+$/,""))});return c.on("end",function(){return _this.remove_from_circle(id)})};Server.prototype.handle_data=function(id,data){console.log(id,"said",data);this.stop_timeout();if(id===this.current_player){if(this.current_number==null){if(!data.match(/^\d+$/)){this.send_to_player(id,{error:"start with a number, please - try again"});this.send_to_player(id,{event:"start"});return}else{this.current_number=parseInt(data,10)}}return this.turn_taken(id,data)}else{return this.send_to_player(id,{error:"not your turn"})}};Server.prototype.send_to_player=function(id,msg){var body,c;body="string"===typeof msg?{message:msg}:msg;c=this.players[id];if(c!=null){c.write(JSON.stringify(body)+"\n");return console.log("sent:",id,body)}else{return console.log("no connection, can't send:",id,body)}};Server.prototype.notify_others_of_new_player=function(id){var player,_i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];if(player!==id){_results.push(this.send_to_player(player,"New player: "+id))}else{_results.push(void 0)}}return _results};Server.prototype.notify_others_of_gone_player=function(id){var player,_i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];_results.push(this.send_to_player(player,"Player gone: "+id))}return _results};Server.prototype.notify_player_of_others=function(id){var msg_parts,player,_i,_len,_ref;msg_parts=[];_ref=this.circle;for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];if(player!==id){msg_parts.push(player)}}if(msg_parts.length>0){msg_parts.unshift("Other players:")}else{msg_parts.unshift("No other players")}return this.send_to_player(id,msg_parts.join(" "))};Server.prototype.notify_others_of_turn=function(id,data){var player,_i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];if(player!==id){_results.push(this.send_to_player(player,{turn:{player:id,said:data}}))}else{_results.push(void 0)}}return _results};Server.prototype.notify_others_of_mistake=function(id){var player,_i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];if(player!==id){_results.push(this.send_to_player(player,id+" must lose!"))}else{_results.push(void 0)}}return _results};Server.prototype.notify_others_of_timeout=function(id){var player,_i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){player=_ref[_i];if(player!==id){_results.push(this.send_to_player(player,id+" was too slow!"))}else{_results.push(void 0)}}return _results};Server.prototype.add_to_circle=function(id,c){this.circle.push(id);this.players[id]=c;console.log("new player",id);this.notify_others_of_new_player(id);this.notify_player_of_others(id);return this.start_game_if_necessary()};Server.prototype.remove_from_circle=function(id){var c,i,index,nc;if(this.circle.indexOf(id)>=0){index=this.circle.indexOf(id);nc=function(){var _i,_len,_ref,_results;_ref=this.circle;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){i=_ref[_i];if(i!==id){_results.push(i)}}return _results}.call(this);this.circle=nc;c=this.players[id];c.end();delete this.players[id];this.notify_others_of_gone_player(id);if(this.should_stop_game()){return this.stop_game()}else{if(id===this.current_player){this.stop_timeout();return this.start_turn(index)}}}};Server.prototype.start_game_if_necessary=function(){if(this.current_player==null&&this.circle.length>1){return this.start_turn(0)}};Server.prototype.should_stop_game=function(){return this.circle.length===1&&this.current_player!=null};Server.prototype.stop_game=function(){this.send_to_player(this.circle[0],{event:"win"});this.current_player=null;return this.current_number=null};Server.prototype.turn_taken=function(id,data){this.notify_others_of_turn(id,data);if(this.is_turn_valid(data)){this.current_number+=1;return this.start_turn(this.circle.indexOf(id)+1)}else{return this.made_mistake(id)}};Server.prototype.is_turn_valid=function(data){var correct_answer;correct_answer=BC.answer(this.current_number);console.log("checking valid: ",data," == ",correct_answer);return correct_answer===data};Server.prototype.start_turn=function(index){this.current_player=this.circle[index%this.circle.length];if(this.current_number!=null){this.send_to_player(this.current_player,{event:"turn"});return this.start_timeout(this.current_player)}else{return this.send_to_player(this.current_player,{event:"start"})}};Server.prototype.start_timeout=function(id){var _this=this;return this.timeout=setTimeout(function(){return _this.timed_out(id)},1e4)};Server.prototype.stop_timeout=function(){if(this.timeout){clearTimeout(this.timeout);return this.timeout=null}};Server.prototype.made_mistake=function(id){this.send_to_player(id,{event:"lose"});this.notify_others_of_mistake(id);return this.remove_from_circle(id)};Server.prototype.timed_out=function(id){console.log("timed_out "+id);console.log("current_p "+this.current_player);if(this.current_player!=null&&this.current_player===id){this.send_to_player(this.current_player,{event:"timedout"});this.notify_others_of_timeout(this.current_player);return this.remove_from_circle(this.current_player)}};return Server}();BC={is_match:function(num,target){return num%target===0||num.toString().indexOf(target.toString())>=0},is_cats:function(num){return this.is_match(num,5)},is_boots:function(num){return this.is_match(num,7)},answer:function(num){var boots,cats;cats=this.is_cats(num);boots=this.is_boots(num);if(boots&&cats){return"boots & cats"}else if(boots){return"boots"}else if(cats){return"cats"}else{return num.toString()}}};module.exports=Server}).call(this);
